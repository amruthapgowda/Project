<% layout("/layouts/boilerplate") -%>

<div class="container mt-4">
    <div class="row mb-3">
        <div class="col text-center ">
            <h3><%= listing.title %></h3>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="card col-md-6 offset-3 show-card listing-card">
            <img 
                src="<%= listing.image?.url || 'https://via.placeholder.com/600x400?text=No+Image' %>" 
                class="card-img-top show-img" 
                alt="listing_image">
            <div class="card-body"> 
                <p class="card-text" >Owned by <i><%=listing.owner.username %></i></p>
                    <br/>
                    
                    <!-- <b><%= listing.title || 'No Title' %></b><br> -->
                    <p class="card-text" ><%= listing.description || 'No Description' %></p>
                    <p class="card-text" ><% if (listing.price != null) { %>
                        â‚¹<%= listing.price.toLocaleString("en-IN") %></p>
                    <% } else { %>
                        <span class="text-muted">Price not available</span>
                    <% } %>
                    <p class="card-text" ><%= listing.location || 'No Location' %></p>
                    <p class="card-text" ><%= listing.country || 'No Country' %></p>
                </p>
            </div>
        </div>
    </div>

    <% if (currUser && currUser._id.toString() === listing.owner._id.toString()) { %>
    <div class="row mt-4 justify-content-center">
        <div class="col-auto">
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">Edit</a>
        </div>
        <div class="col-auto">
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
                <button class="btn delete-btn" type="submit" 
                    onclick="return confirm('Are you sure you want to delete this listing?')">
                    Delete
                </button>
            </form>
        </div>
    </div>
<%}%>

    
    <div class="col-8 offset-3 mb-3">
        <hr>
        <% if(currUser) {%>
        <h4>Leave a review</h4>
        <form action="/listings/<%=listing.id%>/reviews" method="POST" 
             novalidate class="mb-3 needs-validation">
            <div class="mb-3 mt-3">
                <label for="raing" 
                class="form-label">Rating</label>
                 <input type="range" 
                 min="1" 
                 max="5" 
                 id="rating" 
                 name="review[rating]" 
                 class="form-range" 
                 required
                 > 
            </div>
            <div class="mb-3 mt-3">
                <label for="comment" class="form-label">Comment</label>
                <textarea name="review[comment]" id="comment" cols="30" 
                rows="5" 
                class="form-control" required></textarea>
                <div class="invalid-feedback">Please add comments for review....</div>
            </div>
            <button class="btn btn-outline-dark">Submit</button>

        </form>
        <hr/>
        <%}%>

        
        
        <p><b>All Reviews</b></p>
        <div class="row">
            <%for(review of listing.reviews){%>
            <div class="card col-5 ms-3 mb-3">
                <div class="card-body">
                    <h5 class="card-title">@<%= review.author.username%></h5>
                    <p class="card-text"><%=review.comment%></p>
                    <p class="card-text"><%=review.rating%> stars</p>
                    </div>
                    <form class="mb-3" method="POST" action="/listings/<%= listing._id%>/reviews/<%=review._id%>?_method=DELETE">
                        <button class="btn btn-sm btn-dark">Delete</button>
                    </form>
            </div>
            <%}%> 
        </div>       
    </div>
</div>

<!-- Bootstrap validation JS -->
<script>
(() => {
  'use strict';
  const forms = document.querySelectorAll('.needs-validation');

  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }

      form.classList.add('was-validated');
    }, false);
  });
})();
</script>